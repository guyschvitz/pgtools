library(sf)
library(RPostgreSQL)

## Connect to db using admin pw
conn <- dbConnect(dbDriver("PostgreSQL"), dbname="nastacdb", port=5432, host="icr-s05.ethz.ch",
                          user = "admin", password = "hNo7Yoo")


## Function to view tables in database (package gs_funs)
viewPgTables <- function(conn, table=NULL, schema = NULL){
  ## Conn: DBI / RPostgreSQL connection object
  ## table: Regular expression for table
  ## schema: Regular expression for schema

  ## First part of query
  sql1 <- "SELECT DISTINCT table_schema, table_name FROM information_schema.columns "
  ## Middle part 1 (optional)
  sql2 <- ifelse(is.null(table), "", paste0("table_name ILIKE '%", table, "%' "))
  ## Middle part 2 (optional)
  sql3 <- ifelse(is.null(schema), "", paste0("table_schema ILIKE '%", schema, "%' "))
  ## Last part of query
  sql4 <- "ORDER BY table_schema, table_name;"

  if(is.null(table) & is.null(schema)){
    sql <- paste0(sql1, sql4)
    msg <- "Showing all tables in database."
  } else if(is.null(table) & !is.null(schema)){
    sql <- paste0(sql1, "WHERE ", sql3, sql4)
    msg <- paste0("Showing all tables in schema matching '%", schema, "%'")
  } else if(!is.null(table) & is.null(schema)){
    sql <- paste0(sql1, "WHERE ", sql2, sql4)
    msg <- paste0("Showing all tables matching '%", table, "%'")
  } else if(!is.null(table) & !is.null(schema)){
    sql <- paste0(sql1, "WHERE ", sql2, "AND ", sql3, sql4)
    msg <- paste0("Showing tables matching '%", table,
               "%' in schemas matching '%", schema, "'%")
  }
  message(msg)
  return(dbGetQuery(conn, statement = sql))
}

## View all tables
viewPgTables(conn)

## View all tables in schema "dbe"
viewPgTables(conn, schema = "dbe")

## View all tables matching "abram"
viewPgTables(conn, table = "abram")

## View all tables matching "abram" in schema "dbe"
viewPgTables(conn, table = "abram", schema = "dbe")

## Get abramson polygons
ab <- st_read(conn, query = "SELECT * FROM dbe.abramsonclipped")

## Get railroads
viewPgTables(conn, schema = "rsha")

##
rs <- st_read(conn, query = "SELECT * FROM rshapes.raillines")
